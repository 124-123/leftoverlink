{% extends 'navbar.html' %}
{% load static %}
{% block content %}

<!-- Page Metadata -->
<meta charset="UTF-8">
<title>LeftoverLink - Food Listings</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="{% static 'css/responsive.css' %}" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Custom Styles -->
<style>
  .tag-available {
    background-color: #198754;
    color: white;
    border-radius: 0.35rem;
    padding: 3px 10px;
    font-size: 0.85rem;
    font-weight: 600;
  }

  .tag-claimed {
    background-color: #ced4da;
    color: #495057;
    border-radius: 0.35rem;
    padding: 3px 10px;
    font-size: 0.85rem;
    font-weight: 600;
  }

  .sidebar {
    max-width: 260px;
    height: fit-content;
    padding: 1rem;
    border: 1px solid #dee2e6;
    border-radius: 0.5rem;
    background-color: #f8f9fa;
  }

  .sidebar h6 {
    font-weight: 700;
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
    color: #343a40;
  }

  .form-check {
    margin-bottom: 0.5rem;
  }

  .food-card {
    cursor: pointer;
    border-radius: 0.5rem;
    box-shadow: 0 0.15rem 0.3rem rgb(0 0 0 / 0.1);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    background: white;
  }

  .food-card:hover {
    transform: translateY(-6px);
    box-shadow: 0 0.5rem 1rem rgb(0 0 0 / 0.15);
  }

  .food-card img {
    border-top-left-radius: 0.5rem;
    border-top-right-radius: 0.5rem;
    width: 100%;
    height: 180px;
    object-fit: cover;
  }

  .card-body {
    padding: 1rem 1rem 1.25rem;
  }

  .card-title {
    font-size: 1.15rem;
    font-weight: 700;
    color: #212529;
    margin-bottom: 0.4rem;
  }

  .food-quantity {
    font-size: 1rem;
    color: #495057;
    margin-bottom: 0.75rem;
  }

  .expiry-location {
    font-size: 0.85rem;
    color: #6c757d;
    line-height: 1.3;
  }

  @media (min-width: 768px) {
    #map {
      height: 400px;
    }
  }
</style>

<!-- Main Container -->
<div class="container mt-4">
  <div class="row">
    <!-- Sidebar -->
    <div class="col-md-3 sidebar">
      <div class="mb-3">
        <input class="form-control" type="text" placeholder="Search">
      </div>

      <h6>Filter by Category</h6>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" checked id="catFruits">
        <label class="form-check-label" for="catFruits">Fruits</label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" checked id="catVegetables">
        <label class="form-check-label" for="catVegetables">Vegetables</label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" checked id="catCanned">
        <label class="form-check-label" for="catCanned">Canned Goods</label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="catSnacks">
        <label class="form-check-label" for="catSnacks">Snacks</label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="catCooked">
        <label class="form-check-label" for="catCooked">Cooked food</label>
      </div>

      <h6>Sort by</h6>
      <div class="form-check">
        <input class="form-check-input" type="radio" name="sort" checked id="sortNearest">
        <label class="form-check-label" for="sortNearest">Nearest</label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="radio" name="sort" id="sortNewest">
        <label class="form-check-label" for="sortNewest">Newest</label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="radio" name="sort" id="sortPopular">
        <label class="form-check-label" for="sortPopular">Most Popular</label>
      </div>

      <h6>Status Tags</h6>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" checked id="statusAvailable">
        <label class="form-check-label" for="statusAvailable">Available</label>
      </div>
    </div>

    <!-- Listings -->
    <div class="col-md-9">
      <div id="map" style="height: 400px; border-radius: 10px; margin-bottom: 20px;"></div>

      <div class="row g-4">
        {% for post in posts %}
        <div class="col-md-6 col-lg-4">
          <div class="card food-card" data-id="{{ post.id }}">
            <img src="{{ post.food_image.url }}" alt="{{ post.food_title }}">
            <div class="card-body">
              <h6 class="card-title">{{ post.food_title }}</h6>
              <p class="food-quantity">{{ post.quantity }} kg</p>
               <p class="conatact">contact on:-{{ post.contact }} </p>
              <span class="tag-available">Available</span>
              <p class="expiry-location mb-0 mt-2">
                {{ post.expiry|date:"D, d M Y H:i" }}<br>
                {{ post.location }}
               <a href="{% url 'claim_food' post.id %}" class="btn btn-primary">Claim</a>
              </p>
            </div>
          </div>
        </div>
        {% empty %}
        <p>No food items available at the moment.</p>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<script>
  // Parse food post data from backend (passed as JSON)
  var foodPosts = JSON.parse('{{ food_posts_json|escapejs }}');

  // Initialize map
  var map = L.map('map').setView([19.7515, 75.7139], 5);

  // Add OpenStreetMap tile layer
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  var markers = L.layerGroup().addTo(map);

  // Forward geocoding function (location â†’ lat/lng)
  function getCoordsFromAddress(address, callback) {
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`)
      .then(response => response.json())
      .then(data => {
        if (data.length > 0) {
          callback({
            lat: parseFloat(data[0].lat),
            lng: parseFloat(data[0].lon)
          });
        } else {
          console.warn("No coordinates found for location:", address);
        }
      })
      .catch(() => {
        console.error("Error fetching coordinates for:", address);
      });
  }

  // Add markers for food posts using location field
  foodPosts.forEach(function (post) {
    if (post.location) {
      getCoordsFromAddress(post.location, function(coords) {
        var marker = L.marker([coords.lat, coords.lng])
          .bindPopup(`
            <strong>${post.food_title}</strong><br>
            Quantity: ${post.quantity}<br>
            Location: ${post.location}<br>
            Expiry: ${post.expiry}<br>
            <img src="${post.food_image_url}" width="100">
          `);
        markers.addLayer(marker);

        // Adjust map bounds when all markers loaded
        if (markers.getLayers().length > 0) {
          map.fitBounds(markers.getBounds(), { padding: [50, 50] });
        }
      });
    }
  });
</script>

<script>
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');

  document.querySelectorAll(".food-card").forEach(card => {
    card.addEventListener("click", function () {
      let postId = this.getAttribute("data-id");
      // Your fetch or AJAX request can go here if needed
    });
  });
</script>



{%endblock%}